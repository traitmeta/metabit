use tracing::debug;

use super::*;

pub fn check_witness_with_prev_txs(
    tx: &Transaction,
    prev_txs: Vec<Transaction>,
) -> Option<Vec<usize>> {
    let mut res = vec![];
    for (i, input) in tx.input.iter().enumerate() {
        debug!("Input index: {}", i);
        let prev_tx = prev_txs.get(i).unwrap();
        let check_result = check_witness_signed(input, prev_tx);
        if !check_result {
            debug!("    Witness is not valid for input index {}.", i);
            res.push(i);
        }
    }

    if res.is_empty() {
        return None;
    }

    Some(res)
}

pub fn check_witness_signed(input: &TxIn, prev_tx: &Transaction) -> bool {
    if input.witness.len() <= 1 {
        return true;
    }

    let prev_out = prev_tx
        .output
        .get(input.previous_output.vout as usize)
        .unwrap();
    if !(prev_out.script_pubkey.is_p2wsh() || prev_out.script_pubkey.is_p2tr()) {
        return true;
    }

    // try parse witness to script
    let script_instructions = Script::from_bytes(&input.witness[1]).instructions();
    for instruction in script_instructions {
        match instruction {
            Ok(Instruction::Op(opcode)) => {
                debug!("OP Code: {:?}", opcode);
                if opcode == OP_CHECKMULTISIG
                    || opcode == OP_CHECKMULTISIGVERIFY
                    || opcode == OP_CHECKSIG
                    || opcode == OP_CHECKSIGVERIFY
                {
                    debug!("Witness is valid for P2WSH or P2TR.");
                    return true;
                }
            }
            Ok(Instruction::PushBytes(_)) => {
                continue;
            }
            Err(e) => {
                debug!("Error decoding script: {:?}", e);
            }
        }
    }

    false
}

pub fn check_input_signed(input: &TxIn, prev_out: Option<TxOut>) -> bool {
    if input.witness.len() <= 1 {
        return true;
    }

    if prev_out.is_some() {
        let prev = prev_out.unwrap();
        if !(prev.script_pubkey.is_p2wsh() || prev.script_pubkey.is_p2tr()) {
            return true;
        }
    }

    // try parse witness to script
    if input.witness.is_empty() {
        return true;
    }

    for (idx, witness) in input.witness.iter().enumerate() {
        if idx == 0 {
            continue;
        }

        let script_instructions = Script::from_bytes(witness).instructions();
        for instruction in script_instructions {
            match instruction {
                Ok(Instruction::Op(opcode)) => {
                    debug!("    OP Code: {:?}", opcode);
                    if opcode == OP_CHECKMULTISIG
                        || opcode == OP_CHECKMULTISIGVERIFY
                        || opcode == OP_CHECKSIG
                        || opcode == OP_CHECKSIGVERIFY
                    {
                        return true;
                    }
                }
                Ok(Instruction::PushBytes(_)) => {
                    continue;
                }
                Err(e) => {
                    debug!("Error decoding script: {:?}", e);
                }
            }
        }
    }

    false
}

pub fn check_witness(tx: &Transaction, prev_outs: Vec<TxOut>) {
    // parse witness data
    for (i, input) in tx.input.iter().enumerate() {
        info!("Input index: {}", i);
        if input.witness.len() <= 1 {
            continue;
        }

        let prev_out = prev_outs.get(i).unwrap();
        if !(prev_out.script_pubkey.is_p2wsh() || prev_out.script_pubkey.is_p2tr()) {
            continue;
        }

        // try parse witness to script
        let script_instructions = Script::from_bytes(&input.witness[1]).instructions();
        for instruction in script_instructions {
            match instruction {
                Ok(Instruction::Op(opcode)) => {
                    println!("    OP Code: {:?}", opcode);
                }
                Ok(Instruction::PushBytes(bytes)) => {
                    println!("    Data: {:?}", bytes);
                }
                Err(e) => {
                    println!("    Error decoding script: {:?}", e);
                }
            }
        }
    }
}

pub fn check_unsigned_input(tx: Transaction) -> Option<usize> {
    // parse witness data
    for (i, input) in tx.input.iter().enumerate() {
        if input.witness.len() <= 1 {
            continue;
        }

        let signed = is_signed_witness(&input.witness);
        if !signed {
            return Some(i);
        }
    }

    None
}

pub fn is_signed_witness(witness: &Witness) -> bool {
    if let Some(redeem_script_bytes) = witness.last() {
        let redeem_script = Script::from_bytes(redeem_script_bytes);
        redeem_script
            .instructions()
            .any(|instruction| match instruction {
                Ok(opcode) => {
                    opcode == Instruction::Op(OP_CHECKMULTISIG)
                        || opcode == Instruction::Op(OP_CHECKMULTISIGVERIFY)
                        || opcode == Instruction::Op(OP_CHECKSIG)
                        || opcode == Instruction::Op(OP_CHECKSIGVERIFY)
                }
                _ => false,
            })
    } else {
        false
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use bitcoin::blockdata::transaction::Transaction;
    use bitcoin::consensus::encode::deserialize_hex;

    #[test]
    fn tx_all_signed_test() {
        let raw_tx = "02000000000103507aa10a8824fda9e3a213d6d94a97b3dd6e7f993189c0316e516bc904344be3010000000010000000507aa10a8824fda9e3a213d6d94a97b3dd6e7f993189c0316e516bc904344be3000000000010000000625890453cd31111d578d3f0918ae7d8f1dc729d267b0ebe88bef4594c1ceca0010000000010000000010000000000000000036a010002002821031ed510a5fcd7ec5fe79ddc0d51914b3585f5c3ae444e5994581ecd0e06f187d8ac736460b2680200282103937af05b0c3493b5ca9380cc2e5ad52bbf02e19ecaabd9474b844616faf0642dac736460b268020028210380cf1f0ed09ba90ff2c80871512169ce72eaa1a9a1187136549c5600762290e5ac736460b26800000000";

        let tx = deserialize_hex::<Transaction>(&raw_tx).unwrap();
        let unsigned_input = check_unsigned_input(tx);
        assert!(unsigned_input.is_none());
    }

    #[test]
    fn tx_have_unsigned_test() {
        let raw_tx = "0200000000010285238518173326623fdae44c79edc3250f3e8607afbb1415cd74d8a7d2d39712010000000010000000e0e9053a4fc6c353293671887ca22687b0334720740628ce9611abb967dfb3340100000000ffffffff01c90100000000000016001492b8c3a56fac121ddcdffbc85b02fb9ef681038a0221028e5f26ab30ff467d7073374a9d646501fbdbc74b9f65e9029e0a848715fb7d870c093006020103020103017cac030101fd4c0451690063036f7264010117746578742f68746d6c3b636861727365743d7574662d38004d08023c73637269707420646174612d733d2230786364633039653933396366346432346437343261363430316530666365356635303261633530633961633236373937356339346630353430323161663262396622207372633d222f636f6e74656e742f663830623933343636613238633565666337303366616230326265656262663465333265316263346630363361633237666564666437396164393832663263656930223e3c2f7363726970743e3c626f6479207374796c653d22646973706c61793a206e6f6e65223e3c2f626f64793e000000000000000062766d76341b9f04c88ec338467c118dd8b93480a7b619451fdc5a0bdb4a0076785948b25b60ce52916ca796d07e15b15055c068d96ca793ed6614245c598881449451ee3dfc5d430c0c0239d91f6c8ad4340a0fb3883f8b1b806847bb4fe5c936c67703479a7a7e8240a0a11f03e148a751c082986f9d08acd5c5ccffa0fc1a24a9ddb65e3580c563abac5eb7b1d2ca2032558a828440d108c7e26cb601c993b029c52a7645241606270a12a780d901dbaca28622de7983db9b9a4b45d3a5c10f5c53e33372f3ef1f08d45a2d7accce73de526f173c4e0b99d4f55f7629d0891bc791b57c427d01ecb4f31113df1e1e94d0529a91416037b2fe74df80777b3deb2678b28d41e04d5542b219930609142c6449b1a046cb2ed8143489b544c09653c2e44807b6413b65a2f7d1a3654d0802f83a09374f5977df86698c9bfe096a226fe5ebbcfa0573ec0977dae708f71d20d7aa610699a967ec2c7793047d7398495ee08ea3ff55286c0e17e3a2f68650cc6fb90e3baf474fe7d0ebca8ac3e824054a9c890cd9e2b312ed12e80446c419a743ccc168c9123378618e05acb150287a4353699b049c2ed9a79fa393960c2dd3f9d826b6c70409cfa32cfa75ed7353694946bc2865ed41c8011f2993ce9ab00372c86e1a69305f6b56adf7bc2749d7a1e307ac782b4132f263289cb0b9e4595134a6f9f24dd734d62e08839528cec6a2e88cd9304607310030fb6c4208b978cd3161c2a09501afad33f92172c26c317301fecc15f3a58d04cd0c02abbf7eff128e4e61c3a04f0e32a6747569abcd382f647fb51429870c52074228efe1e963eca45d63190c807e4820bc2230aeb7ba898fbea22a6b692074300601fb8a4a06a308b22fe2357a40d4de73e0582c199badd3e208b88885e292513971489e1493f312c3007c3fc9591d0ea114f1b6654af47f3a1b748847a46618c91bb84a9bff61857ec1f36a60d843d6e57649dc9bb1f64f27eab16f6b7f4d49878cea72b9defebd7462fd2f13b475077e2ea98e04f701bca384268a294c9c821013834b208931ba4c42e03d581fd804133446cfda6451a0ad42f10207ad15a78731d4ef6b6d72a71ded7b8faf587ffc8f3f0d1fcaf2af05d6e0b5ad6b214a6f7e69fbcfefb968c5a4f72d12acf35f113ac0d2148bf96ff9d6b8f89148e5180d006821c0053d02842250ee6affd17a4ec4cbfa79a39d4259f9424db9576768fdc11de4e700000000";

        let tx = deserialize_hex::<Transaction>(&raw_tx).unwrap();
        let unsigned_input = check_unsigned_input(tx);
        assert!(unsigned_input.is_some());
        assert_eq!(unsigned_input.unwrap(), 1);
    }

    #[test]
    fn check_input_signed_test() {
        let raw_tx = "02000000000101320e90c53411d10194b50bc22b359a5c3441998661a733501fa190e6ffc50be60200000000fdffffff012202000000000000225120937ad9cb999e5aee75d91e398e33b0a45e64c2a532a2adf3c0e10c838dcf78250340e5e258b30dea7e3ae9a5f287d77a68781565fb064fd5dad9272ea1f9fcb008b5f6ded6f47cf31248c362215a1c614f806bbfdcfc03ffaf0decefb19ec1b4243ffde226203eb2c7e889f70ea5c245da0df6833abeded3256b0bf69439d4be23107f0acc61ac0063036f726401010a696d6167652f77656270004d0802524946466a26000057454250565038580a00000030000000ff0000ff000049434350c8010000000001c800000000043000006d6e74725247422058595a2007e00001000100000000000061637370000000000000000000000000000000000000000000000000000000010000f6d6000100000000d32d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000964657363000000f0000000247258595a00000114000000146758595a00000128000000146258595a0000013c00000014777470740000015000000014725452430000016400000028675452430000016400000028625452430000016400000028637072740000018c0000003c6d6c756300000000000000010000000c656e5553000000080000001c007300520047004258595a200000000000006fa2000038f50000039058595a2000000000000062990000b785000018da58595a2000000000000024a000000f840000b6cf58595a20000000000000f6d6000100000000d32d706172610000000000040000000266660000f2a700000d59000013d000000a5b00000000000000006d6c756300000000000000010000000c656e5553000000200000001c0047006f006f0067006c006500200049006e0063002e00200032003000310036414c50484b000000011720164cfc79d79f4644c402834692141d4d0802fa5a0987fedd30dfff2411fd9f0056dfc444cd103d5fbeeb4bd303e07c7af8956f1f7ee5cfdfff335fbee79bbafb7fa4e9e157dabe1f78d11d005650382028240000b084009d012a000100013e3d1c8b442221a11339e5d02003c4b13770b688522e5ff37f8e9dd11c4fbd7e397f58ff9fff3fe6f6d0fdafefa7ed3ffb5e73db13cbe7ccbf58ff1ffddbf6c7fbe7ffffa77e8bbf50ffc3f705fd2dfefbfe03f68ffc07ffff9d7f597fde7d037f35feebfebffb97efc7cad7fbdfd8ef797fd5ffd57fbaf707fe69fd73ad8ff72fd833f9f7f76ffc7ecd1ff37f6efe153f6c3ff0ffb4f80efe71fdd7fe1fe7d77007ff4eaffe9e7f75fc88f097fca7e54f5dc7a6bd94e579d3fe6bff28fb13f8dfee5fb67fde7f713ef0ff13fdb3f307cd5e00bf8fff29ff01f965f99deaf1dc51b07982fb0df47ff33fd73fbaffd7ff1bf0fff57fe7ff2dfdc4f9b9f700fe63fcfffc8ff68fdd6fecdf29ffc1ff71e2edf54ffbfec03fc47faf7f9ffec9fe13fec7f85fa61fe9ffdfff95ff4bff7ffc37b32fd0ffd9ffd0ff0dfbd3fe87ec1bf93ff40ff49fd83fc87fdfff43ffffff1fdd9fad0fdd0ffd5ee21faadfef3f3c0db448f553bbe94ed2bfb72f9095cdb9062dda9daf9867fd58e7d6c417a0a8c497f5823ac3aefb52335ec050b47bd835006c3282bbe38ec7c18f154d21e34fbf1c81d15d1d0ca2fa350506eaa2cc20979393e424d1cd52fb9c8fba234d0802bb1f17d31ef84fcc09b3dac014bf72f78271d0653b618559bc71b4db848eec93c9b2c746caaec77ab2be23d930a413fcdee2b43e9b61a9f7a5ae975b5272d45f509de162645d4fcee06fcea039c9c304e0f55394b773dd214203c80e6021808369a20f5977b97b5e07e2eefa974096bb1019b08e6d663250357b3b121a6e8b01662aa02a253619f2223664e010c5224a9f8fdead0c53373804cbd3722b7b85411fe5864efb10ff416aa53c134ba2f8e9b76c443fcf01a3b5d8a9713c65d119a6fd4b3eb6f92637815e4d5770da29865a7fa6de28ce9dd51c542dad2144d0c0434ff0a54bfdbf3e84fd453d6b88c1d0b4843d00dfcae5d9e87227b64d0f0d61a170c1515f909f064b38fd13920188a729ccc871e8ca7264101c2dafdd2efae337e7f517e153abcd3e40fdf298367caa885fad3f618d16f247fec40396ef7d88d4d283ee067e3240f555863c5643c04a63def8bd303b4f437e3621d91a4d82e8b8ac1808fb93a6891ebe9823f1e9a63c29cd359bb686d9c2911dbfef4a47ba126e4292d2c3a428f961ce8a89007d07b358a322cfb2c9a6a61a325664636a21c72da44b39785827dd7b2779a728d45cc96f0caa9b576e7963dcba73c77ea1524792b0677bdfae45a182942fb015bdfd964b2e34f17463ab91f99e41955f3c34ac014f299cb48c29e6df99d93700659c76b5f3f29f365681b4f54f98c753eedf6c3f2afaab0f2451da984d08022798f07e69994326233b27437392fa5d626e5d6f97670591630b2d8038efc2872e46c6fbe1d99398e55c5a6dda74fc520b66b1a971e0a239a0b28539e30f9758cba445df25b53e02b1ba99647e8288c42b6b8baba70570465e2e5f1f889cf50000feff78b94da29ed39c65bb9e1d0055256834f3f6012f49d25ddb065acc69fec37dfa83fb696d6712b0dec026cae802a69cb8ef6d7693712d05c0d6c055f638a53fd903cab0511d9c3955dd163eacee6e5e9e67f1bf969111d68092699b8a899a4f9a3e89b5482b6492081aeeaacf339333fdba30d7a1ed6b6053dcbf8767f25405086e3d31f9064460b5b253fa051c4523a1834bd9fc0c8846f890c7de9131fdf9c0b7e0d6d0233cd5143fb72c639f75b3999bec6a35fc038108a485d3c7a58f1b04a6fcaf40ad69e0476018735490ca744dad0e9de9c603e3df63d94f2faa614026102e4abad0c1a0dc2f51b01cb989adfc4f169cb71b05732833794bb4cf091824aeeb0a4a7ce2bae291df0210ced2b95ab358c8c16b064bb3a7637730bac85436cf2396c643a72e9e85ab62798e8f4686ced5bd7ceb959707c8b7e1056d17fd6a22b556392c30e9221996ca8490d516b62d289c49e86eb952f47301a1800900c583d463e880dce091fe45d1152f5ddf0b480014c0e78a821bae69cd9d95076664b68beaa6bfd1467da7f48c64ae24a4be13d03a7f8c80f0b102f57b9725d9e1ad1fef2ef7a64d08027f562339403d5e6fd6bf9c1e7fdfe3d66efca86b892fb18e5ebf81e7a90fb84863e26b84803bf000002621a650b9d91cd7aad84b7e749eee785aa1e6a4374a40de25698f1b9f1f3d637852e496785921603313e6c3a42ed22b9dfb866a2786cb5b0b6e8f8f4082c67441d52a7dfab6584f29fa74a5b4b041378ba754b808182d5121e9e7f739fa609be6298af6780c909c1d9cc4eb468d8bc8cc08723f7d42a69102facb7386bcfd818075ef1d6d232e400130362a282f4b4b74672d025c9563ba0055a403fe34890d1431aecd09faf8c2f207d3e09f0e3c14a72e57d3627099d61a6dba1b292fc172e62854de25f43e089cdc0bbe419acf48384bbc18de93ded9026fb2199e64d6513f75ef40605688a06b61e51d758780af76dded2e9543182acc540291208ba76993989d1c4378ac6e36fcda249bc80c9df69434dfc3a560fcfb69f9261dd63403ff105b4df7235723466beb945ccddee64290c3f8798e913d79be7747de6b1f700dd43382c6c74f58b7a5295910f1e0427143f751595784b39ffd628da18e8c1dbcd02d7ddd44ade9ae68ee2e190bd028545181c411504add7de857f7e1381d1308482891b43bce8e17acbe701f18fba775636dae29fa51458966d30763aa3f4f87cb684a3c6fdc301f9672fe4d9a2641e4bfe2fad0d8231267a465f494380e994424e7856f1f4e588c903b427f6da6e073943beda8c339272c5186b54b89124d08029ba8f4365783ce1e3d51f4bfd5c165dffee7d14c02ad69e88f5825407acd2c3012e9315ded59ed1f942665036c5c12c732ced400a4394ae8b496efc342432b2e7a7e3dbdaa4da8f7d740f63117fdba6a61b8e7cffa95bc697c0829cb451e6fa2fe549ae571c73c3d42d009b19af32d3d6c1e6c4e0e2b950b566e2c97a7c636e76e1776d90f70eb65bbaecc9c2843add38f708002baa2eda2572d7b47018e74fab00bc2048ee6c6614bb1cd70282cfc948cfad39c11997eb97db1856f46b2ad2d71823161e3e2bc5f0b3e8a1922f1739ea873cff6e0c7f43f471736429681ea2f73160cbbbef91395f48cd3ec00245464ff291d009efabc6bb1c5e4c9d9ee79593e350630bdd9276db5e065e7e94f858371da0c0b77d2d26f4fd8dfb7123e055220543c8579e1b03c48bbde5823fb5af09dc8846f3930160ef6142609f47ada1b5e03ee549dd91117e9f175ea18a159f5adb4d41c1e2c3a6f0b7f35072968e5ad96700ffaa2fe07156fb5c3d86903bce82e469ff3ca412b01edc6968613d2a65ab8282fd14eb3e553fd41a114bc51fdfd6d374ddfb42257501158894957d6b78ff72c1c5b32153d99e8bf753b86dfa6998864b93c71a4eac2138c3ff03cd2ce9683332cfeeb674ab3bccaadd9ad921f11cc95c0ab42bf27192ae55529097d36e99cf54d9f4230130962668c176b1252387fbcb2413e2575a23541aafd348819c11c5eab129376e5d94d0802918c365ade951d71d8751f8f33a9232693cfbb47d598505cca369dced7f69b94850646515628924be98516e6f3514edcf1e96c8ce2c944265cc8e6b5de9faceaaca4057950d77a7de22348f3a9d16224736e4b8ca9003fca0804aa371056e107d42f8d3805d37af3e7245391815cc2814719e4a2d7136b0c4e4fabb1802fccce09096bd91bfee32a5a7332ff00eaf0b74ca3ae386180036c48db19d22bc18d8495243fa347dcfc4d9bbe1f43803aac291b85af14ee83da6d1e9e494f5d1e82e5b3859942a16a46fcdc1ec0ecec003289a409101593b413823a1fb93fa544391a1cc8fd3418ff0bff827f4b4a1b54457a7a1411bc25e4a4a76c71856bacdb6e94404d579024a6835424938162eeea9931954cb17c23cc1e4b16c76e8375b5bd35003da15ffd32e12ee373aa7b3a9cf2abd4be90c3935932217dad740caefb62d1e3f76f12bf43b8d64525310c25a604dc53d08ad6c7d76af2023a0fc25060260b3f15b492356779bb027b85beb946a7c3dbed1a6163575acf04a19fff2bf22f9c793c3ae0713ebac8bc83d1826f77c7aa3c5d2ee2e07ddd67cfbb46a71244ba1429295a4fe3b411f33332f9ec783e80e516aed389bbd82da49df8027378032f2815c34bb09600ca61e3bdc9aa64313169c606f9c1120d3d7ad3998da648548f8edd6da87f1ebc92550855b0a2fa67b7ea01dd0cc055d82e356e543c9835430e6b6886035a60c226194d0802e31fc8fcf04256eee4b7cf3a8d224592b6b4fff8310f8aa806943c4567a041e0e7fe287ce3217a6ac8a6ca1cbd935ee688381759e221105f0a1fad5f13e0437db7a2474815dbc5f30a35947bc23fbc0b7e8ca498421e9d90b44174a8f4e8a447941f42cad50d2eb445102372e766b62b93b5c58e5db11905bb51c93e46f508d2f544d4fc6558baaedda5d1ff2381f9a892a364cf26a1faf722945d435574669b9d04194761a94b8fd6d4e60313f61c1a674d67b5c0f1e456738a8085ffa5e83ff3444fec1cb375cdd1950fb98fba6889f66f5fae44a141728eeabb9c87742c51c669f33b6dfbe9bcd3a658ae3f79a381e73e76e9bf9a8834d865fa6eed0156c57594224fad52bfa2ce726d9246f3fd886809e136e41fc82a2fa8002d48c6c3a42e1d13771632935464084234403c55c6ea217fbcaa4878c095555b13b4902a11bf8b5646a4396392b7919660bc36cfd8ad12394263de5170ffb0c5c88accf9416c9fd23ab88913a479008d941421bf45c29a8cb1b5ef985d40487bdfba618ff21b461fb18e4dd8865a519e82223d6e64a488ec89541cccda5a01b5c3d2c112021b098bd1f2cc9fa144612f82512f0f5887ab79cabf8287168ea1b4a5f0cf96c76912d9ef287664913242a61d3c33ecc187417b721e60afc4281b6d85f01db9e81825bb01ac8985285270a7a60525e873e8f40fe735f09fd21742836dbc0cdc9355c7621f13b8a10f4d0802644d71575a24f91fc4aaf65e319d7963f112cc2f74f4bf7e062f49dc1bac322af66ae7fc3ec440bcc05c59149f2f7686a310e88964a3247dba2441112d0c1e394f15db12df45a95058c490176a47e264dbb30c87cbc26e18210bacf88f841b2e29d24141a65a1884b1eede057e97289ca954ec401091342a7a9ee74c7d2de702c62a26efa734d8ac7f7afeac4671fe478e6bdf9c26f8d47e2bf536f6f271f4e17710de97015f0ae0c82052554c80b64448e1cf6ffe1091606720fe5fe3a2e4c4305f0addd3df159f860cd19ca84210e22d5dd0a8f53c7db394e49feed4d8498b0fa47da822db9ac30ffce94b4bbb58a41533079e925c8727664613fb5e1ff4e7ea5b365784e9b414cb1a967fb9d2b709833cc50226c8689f88128b01116606ce48b1679248cd4ef872c78d6365c248896d8ce8ab65b599ed8594456e23f149011140a9b18ab76a5e9adfbac61059798cdcaab24a602355ee4b62e0d2e72df3a0cbf883a1701372a09dc4b139bbe4e2f7f478730061242174dc9261a23ad749c1b23b6c0ffc5dc91da9688c8d364380ccea351b5bd47dce63c8f277fef2dea169ea7f409ab7cb76d9c8405159df311a9e5c34e78066298b0d0ed91fd5945a97a4c6fda031a57e9682132b5aba8b4578ed4871bad9166d83f35c0017ddd2f3378f5c611aa00bde6df9e55456e83671f06010ec7668d447b9d194e89d557af63a96fc234f156168681e4d08028bfb3348c0604c8d5247101052f0a27b545ae733ec0288ddef00d0646542c796bf490947a3101aa49e56ea10adaa873688b7560c3644ece489aabda21223b8f8a2d07b389533b41271e3c7a6165aa18c8e2bd3bf4f95b2f91f02ec088d4b4c5ccad34eff72c00b2043e646d68cc779ef4ac16f8a587fa80bbc2b7b4f51a13debf79517f5ef5d5bf2f9ab47b78f7d2ba6996ee672e01955c0a4361e97e0258cea977e719e1f5043d55d76398db96edba68894ba95dd1ec29b55787e18965027b40ac5d76a769b630ef91f5617067f5d8f96101ca4d903fdc85683565928c02d466095e9b4a8774467d92e6503e615d6fb975c82a1155515c91bbcadc459fcac86c5e7d643cc250e50cc6fae9eb2d8e03e730ef77abd2091de802eb68488ef0af1f0e829d091814ab534aaa511961635984ac07b411019d36ae4b2b37111bdfd6498ce82cd9d99bbe5dcea01eb397647024e8f2b3347cff920de67b52d2e8c80cfb916c8c463a1a7a2df3b7c5e0cbebb4d39b3b30824821f78da416d4cff9b3d756292ba787f368e5f9fa5096f55bb9b0b5d4644329fb3e0007e4540ce94a437bdec47127ef3c9aa1e152dbefe2932d59f3f4369c3d5d5210e4dd3fe9e4ec2d2bde88fcd24ab151b631099c66511a0de98ac5c9c8e522fbb11156e5c1eac31283644cc42f62ab62d555c247735fedccef34045582d52d2dfc4acee5d2dddfab66d411b34bbfdd0e7834d08026615b5b121585103334dc1d137275ee79ba18cf8070bdded2361a44fd9ade990ffc2e20e1af51ea5e81ca82ab8a9380f83cb747954df98f8d1fec269572f279ec24a7cbfdef68457def81c98c1e421db25d071d3e984bfbd436dd2abc1f83f5c668e30a266993f9b3205c3e284bb40f23ca9733f4f9d1c53c0d4020e5f48ed97626b85f2e84c44bf6d6f08c5f19ef4c64878cb6803501ce7d7caf196a5790a4ac028f8545101a36ef0ef565fbb38aa3d76b6a933405e71931bb509aa9530f849f3d5213d7b2c7016f817760abf2573fefb473c5c8315dac672cf799e1fa69658859b5edf586821c5fc8e8590cb800ede1cc30101682ed5dcfa6ff1aac24c8e8ca4e015a89f2b7d72ed9b83e3b5a3497354405caf5af0f1a6bc30429e066c755078d88b7cc4e6887c8db33900aaea4b7ffe156d1c7f0afca1223e678d2322a8ef2b3e6b17a85faf380f8ab4a16ca1c92479f5519d0fe6ed8982d21dc111f0e987fe84e18af22f678745e37f2d3072b8c193e334031a38c63f9d10cf15dbe610b7e3d039ea7fbb254c62463b71a5cff45f25d22faa4f4ed7fe4766e83aef640e524fb8e80d67e04f6389575c26eeba93ebea38af333963cb3f9a7df5c77d8ddc676022346edfefbac7bd879bd9b74fe87a7cd09977bea5769a7664c4465d0d6925b92093321192a8c4849fd88dfb87af4e184bd5b8662232c0b2671ba8da45cb1035561cd7123ae2804d08025e124ffbe67334a8552a981ead7fdb3d9d71c5b492f82fdad6e2aeb3e1534f190d70ff94a565c9c7747eacbefeb1bca5e3360d0d5c2e1790849f4d7ce0a9cac5447ff1d7f6ef1d0ec1393aac20842d3a9276639cc0d464637313ef30060034ff689ed8514f4d3a53cf52e6de8dff5b317d22d9c1b74afca6748c1fe305db7b1fcf4e863a3b4aa86189efb31184e1a085b8fc4c2eb72dc103aa378666f4e3ec05f3603943a30146dec62b7a57f04df3c7c731805656c8cf72671de82d3e58284c7fa14bc0d47bedc5b9592d8abf54840bde9d77f0fb2836740272406463e45cc92e8bf97054c6dd236eef9e670a5f85a9b14b052c795bdac8ae4a990f3ebe49c551a14ff4091f440a7c17b0594037678fb52afec7a20cc499803f5c6ea754b887e83d3c1c80b55cf6dc37081e6ec3b5dbb64dfe506a320c05ec49d6ce0582349b852bb10b21651a920b19c90ffbd9b9bb744d933d863b4c074f3eba85bd3942ddd55ebb2333d0ef1f6f7773678691361539ad5dfbe554ce03a936469366af36d1263fd2d86dd5893ba6ee1eb3fe227cf44e2c759feb6361a58c1947faa2866aec24bb1905e157ca023333fdca1d0149db8f05eb060535211e1770c22072d795f1eca94bf39101cdd96a54b3b1532f67ced7693b3351e79cc40261974ff0297c2111b73ac80f0b9531fcf1ed01437ff038b7c506df6192df3a95eb7494030bdfeea717e4f60de3ea1d4d080215f55d6753c1ef757b30297a3db6cb5dd9db0fce791864fac6c0e129989aa87c99934526a7c8ce2cfc53b90d5343fc09615aa43504a64e87d4cfa1ca847e1d996b2f55cea0f681bfb1f4761adf3a89c8d5def1b32c4b30592a14a8965a5cfa1862d5bbff302525e105df5e6ac8d29d353f9e7d805c8bd73364eab1092feeca311f9f71f5a2be7aea650eeff49af1e1d98a72939acdc2a5354f9b6c294aadc32cce30589286dbea2c6dc0440a20a8cf287b388afa0a4c4482c4dc7d700015a3af046ec9c64c5e3c3e306692338ac444ea9bd99a495a79891cb7103c46e0b53b57f0e3d31bd48c245e722428c60db6fadcb9ca27707fcf3fcf41749ff7c538ce51ba387fe4e99f52396bfec146e332274cf1a2f054f99a2eda28dc1cd8455eafbf867287ad6bdc42afc3e31a79550ce7b4a1262e6630645013dc8dcdcf576b9a5a559440c6a09ce00403bc1c96afe2164000b176c231951e705ba75771de4248a781fafdfe3b8261ea6998d5a7f24773619d6f053f41a2e1d67fe5554ee33a9f6c92dde3441f8c2115e254898c7dcd14c0175b129c92cf8736b5ace2fa492d5cdc61d952095567e86fb58440e616e995ea2b43a82f9d5852aea5d7d2d70b3359a09a7f0ea6ef8c6a59adc093c22944f908e0d4ea9b83dc647eccec18503d6b05378a3f2f10df2465c87101f4f52883b2a6b7c25e05247b3b227999c879c76ffe6ddee5f0dfff07f8b14d08020737e27917bb929b70e7a25e3342d7986b0a55dabbf5199f0000d5c429f0cd83509439f2f11aabea34a121a6df80c356e5fd490a18c66d309c58cb4cc5618a6a13b944dbeb2bc92607abb0dcbcca48eb167e53545adfb7afc5acb22e4e50ef0be328b3d144f071cd83568ccc033c1ec1d912da54ef904af62247534ac2095a13cab45aee4bb98e6e7900ce22b76d7a2c5e5e10fa72152173bd584550e39cf0d9a104964e744cbc2dd5bdf87f16ca2be53b953649bd05a2abc0cd595895a568d71a1c5310b9a184ad135694ceb4b68e2317a9f0cd3bd76564bcc2526aabf754e7583421c6f6598c0134667e32e0d3d0041c3cbe956e1fc74872beca04c0dad955cb828c2c95f46c209e1e7976db2e6bd1d41ba4ce7aeec8b5d104ac577910535042ec9d33f5384ef6dcf5d587ceae3ec3aa95f305a719eaeba85d1cbb3bcb93eabffa5b77e2a0c2889db1427a2777a047374e6207cf8b9f7d10ca7d9ed95a559af4d4cb7c432017d17ffd2392fd51ed4474dc6ffb7bf90efd9130a4113fa8b7c18a66e68db667a6921308010f30798af42c2e1afb8c196fed9dd4efae869081652f70971ea260e1081adf1ecdd58e7e149008af46824de5bd5509e313a950150288dc101aec11d1e43d8de7e1a3acdfe4c3601a8b0b8a1603a6f7f0a9fd6ae1b90b8dbc4919e32352b084841a26d74ef9213ee5b716ec07772626d243308202645fca61d79cf297af4d08021c4591eee4d5217a038ba928ff0b164a50050361033c0977c6c0414289ff643dee71a52577c23eac0709a9445813b2bdcd2cd5dbe3896b1590a93803c6a8a3f33e849ca7a78b5df5545bb8ed15492484f44fffd520883c8a4dff8675776e9e9ee74108a72a16817814a6d8a30297c52b7f2d076d9b363e06d71bad147f70ab704859b3a43a17cf9b997ea4dda80c974bb95c9cfe83034f53efa6638403e5f2379a33b18e88f2de36f62f34c0d09ecc08ad357c64131e4a356d26574160dcc1f8207ce0067329e2aaebacaeecda6fc03c151d98a53a3f4a1a7acf9472ebd349b8a716ad8c44f3c33452332b790f3a09602d7db6dce047f8fd35b7ae73dc847eebf66d33528ff4893247ffee08f12aabaf389802656e9162508824fd46237e0a6507740c5a4cfc5c0efa0c62c72b588338486d4a7c65c6cea9f1df1147c36e4793e39b76e0a996ce6b94bd2743c0aa6ad8a0d5ae7e027c5ef42b3203d1bc1b146d3e7926ebc6b96163bd82fa6637262d0a9f2405419c30e1eb20d425f6ac80442329cc8b593f0e55a1cd5b14d8a7d2b31c454b86dbf5c42808dfbcb2c08ab35a74354cb1e10da205efec259abdb9dc1a4d7e163733d42df0a54e9c34c99e1cf1f83a2b263eaa7a67b8c8143e01f95b06459d685215ccb26e053a1104570042f28acdb0b9b2504f57b51f4ebad9b081a9d92b52cf3f373a3f9502bbd43da06c511460676fa41a1b2ae64d080220f461fd65504f328f4d9f308095c9d92936840ea2599400aa1f7de2a2f649ac57a5232f427d543fb2d0d38f1b0ce4842a7aebb5437c1a836eb534d2665f492db16de20f98d72526e72008309e8346f62791ff221db570d4f603c651584f534e6cb5b516dfbe14db0397bab74da268198d2bd70560bee6db45c7be935bc4dee801f96e581e1181d01be9af44c84e31bce39c50f266de8e9ee7fe741aee74954918ed0c733d09c37ff9a45304b04b1d2aec407081f3632a1046317ba92a81236092c5c2e9eba94838467e492e9687db5edd1203e7dedf1fc27f663e173bc1548db6bf4a46c7ae7ebdf9663e09adbb144b050f15c7be27e885fc7574644aed3650acb5a4377d1fc97eef221c9edcb592855864400d36705582b69ee07a4ab35e46550b25d7e671bd804ff6cc3bc8fbd9340cc4f522564e5a7809de94fd4b845ea9fb998990eb9bd296dd337efb230b34bfe7f327b13f1ba475855d5d8ba71110c56e5d2697bfa2eafebc1475ca010a6e1c9146a9195038ffaf54f175ab6cae5aea5d786df44a9371bfbbd790ec5834e81713340ded7254cdafcb8d82c151cf9faf51e2806034ee64d45ef471ddacfbe2de2e6bae33717b12da1a2b9e74d34bdb6852d01c816d8dab5c01f224a589d04276489e5d5e9a08e3197ee60d7cbec8c1b5c464abbf6f62e9cbd7ecc42adfcc4299da017f49616dc77216dcbdab1b8f8e332c199c0f23e27a1e4d0802cbc881d18e1264b496cc2e152804d1c2b070f59c2699459b23958552cd6f72dc1533a7016b27954ad5953f6b06918d540db27f84291c3c9592d4c17fd8fe46e92323d08866e44e806d23d0d18eaefc2d63f3b9c0c6de32fcdafe70e82d8f625233f2cc443502aceea7ec32dce8fd832123c8936da47427ddea6745839c31a23ddcab0a5714b8e67156315524d05cb45660041e8cb5639d4b38bba47cb71eed824e9fc76e2dc382058fc134738a2efefab5b374c4b1bc3b89c6b504437fea67714c1b5b80ba0d429fe8f79958fbef22da74729c328593d78d87bd41aab2d0c2a9872d98c0f6dc7f69a37470d6198866806fc0991127b302790fa1073a8f3690318ab8f2a6ca83ae210ffc42837e677471a7cbf096b22dbb7680d51257b29177d62d37e364a981ea52690f1608e20e372afb81253617a8e87408088512f7c964c18588c4f827342d5db4855692ad2df143f6651e75749b0dbbde47286046b3bafbda283087786c2775b3f877b329406064c2abe2d1e96e1eb1bd4fed9be2ef7e604a598808c0425ec53568f82c8869037be0191c7a624fe2947dd5848de74aff703c378471bc5a60fe8d04b3c8be56d94b5bab1dc78d10a0189622d9c453b3ef6970d562f6bb4fa805c96f004e0d3aaaaaec2f8365c0f54577d6cee586faf564edec8427c6bf3bc721efda4772a54de19217264471c93d195ce962b8b4ce95b52b2805365a0c98e3724d080268ee9e8f643d3bb2be138ce85c0980fd16dc475bb65e9fcf763621a9aa877ca0f1f88d40cea2eaacd682657fea9caca9cd049a899a800a9876ebc8b5a6922eeb688ef9458574710f9e0fb8a6b63ad5316284cd97a5b3b8d2c373acf2ca007a6d15d1a0eec6da7b934985304c08ecabb18c30e3655596a12b35d5e9fd112fcb8a7f1037a89c8ec8691d3546224cb38a417ce8d7af4ca8eeac0924b481af07ce0d26fa885f0a8fbea526162b21cf0e74b3ccb72310ad5fc0206d893a33dfe799aa6e1690e16fffb422d503a95b945e60dff570fc845575407e459ecb2f7a7efd8006df2bdff485e44013401838a0f8be3928ccb9164eeb45602b1ae81065c328bb1b12ff1b62bb411a399bf1185d842df716491861045ba975b4dea0d23043908e89e757d444fe59596a20a7596ae52acfdc9248b523c0e690b7d8d514b48c3f9feb2711f0cac90c8334ed7faf5333ef7e87f0e61adaa0bd03064f90f442e076b01398caa5147268c9118fe503c31876a251b2c2641cc78892101915106fb94ea2811ff1edc885d67c261ce6561e2795e02d159958e20f52d4132f5507308d9c6f1cf0a3551fe723bf4941d54914c6758f5f66f17b2c4a479b039d533ff2557fd2a4ee352962df4035daf9a31f3d72f925fd781548fd79f17bc096e942075e514ff350e24d94e6cf9850426f9fa5aa9ff01bda213faf94aa3d5b26de83f1f475d47c43e60c364fec314de20120d53a2764bf6b4d4641f254e37962d3904bdd217d2071e9532f49c7fec5f25ca6b387185b2378fbbd5380d8eaf0ac0bec3def03602c9039c8f67e3372a904821453eaec3377b16d2f345c9874c25da52fccfd5bcab083984891480173b4a4a211d850dc7193b6e0451b6ecd4632788ebbb89161b89b133f044da317b24f265c80c90a638c4cb26929db9cd43dc814577410711f40440a4c2f721120b4610553b726129c48c4418c57998b27ee2c151a775d2098bb5cca4bd2513fae52fca91ae43daa3ac4418e68533aed8a9b8a6f784db5116f2256f1c16bd8097ea48fb391e45a521b7598b421f9fd189f7a60d4c7406f81d6c935c492663eb7cc93e4f9309f9e26bbb9d2cad1acd88204b19a0b48cc621f8f799fc9d57afb066251373f84282452d9f471404af5a8b3e8e843568c5115936a8d38971a6be2bed76ff0bea8f6702bb588970370184bf1c0f62754510055fd287f138e7c42455081e070709520c58447735c2020d615c01d6cd8786508d7ecc53f3381030d928f82b85e0b3db9474dfde0a1a9d24509731b6b3010576f842ce1ef7e50cf463c701ddb7230c0376e1700057fa27e18bc2216c12de688655f18196af0addb7574158e79eee5fcd4d4b32b1d9c04e139a2f2fabf52d2663bc97416a64bf762dc2483ecea5c131800006821c03eb2c7e889f70ea5c245da0df6833abeded3256b0bf69439d4be23107f0acc6100000000";

        let tx = deserialize_hex::<Transaction>(&raw_tx).unwrap();
        let res = check_input_signed(tx.input.first().unwrap(), None);
        assert!(res);
    }

    #[test]
    fn tx_have_unsigned_with_p2wpk_test() {
        let raw_tx = "02000000000102fae3a967247516d8775b0bcd5e746774bc0e4984f8b9e3a0f40384125b4724cd0000000000ffffffffb43799c9a61437309ba6dc0e3439b46a5900d67c97ebc203196a0d4cade66d560000000000ffffffff01e40600000000000016001492b8c3a56fac121ddcdffbc85b02fb9ef681038a024730440220418e31398367a2fec90941a70abe63cfe25f91105d29b9f0fc8e69afce7fa0eb02207d01d54551b8897df2e9e452864142689aaafd0e6e567b7ecc9c265380fbbdf20121030c7196376bc1df61b6da6ee711868fd30e370dd273332bfb02a2287d11e2e9c5030101fd030351690063036f7264010117746578742f68746d6c3b636861727365743d7574662d38004d08023c73637269707420646174612d733d2230786339643035366135373231633366613864343235633362333238663463386436326565383531613266326661623631343661643836333761323935373066633222207372633d222f636f6e74656e742f663830623933343636613238633565666337303366616230326265656262663465333265316263346630363361633237666564666437396164393832663263656930223e3c2f7363726970743e3c626f6479207374796c653d22646973706c61793a206e6f6e65223e3c2f626f64793e000000000000000062766d76341b560250af066c6318be694891e7297e9522b3b92855c7b4573147a8f4cbb5f7191ccb56755e7261d7b2ade7649302826290b5c89f35900354df03e6a0a0407f80907c1a18a7530598c05bd540a323a504c1069c60a001c9b6f382e78506be4e0ee87ec1a31cc40fc8510bc20c4a8085870c40807a0ce05b553b28a3defb4b5d81a7c3d3b891ce9e4f3f3fbf9baf867ea485ec283f8a3797fefd6a1064cd70af31c8d7d6a51b9adb7c1ea68c53e503c93511a0280389805632c58827b9648e7157c9a845540aed1910323aa436520a54496d95a0ced8d1ceae9a5b221ffafaedde47f7c08a66cc03fde8971288e37fadcf1ea47e2cb5c66566f2714f089df8f3ee897574d874c5808df5f7c588aa80a40d78162e7e5bf169c7cb22c75e700e0884232b61803c450e6a4cd2cb3993a4d2606c2cb1981a2c1557800431d2590e885582d6446b86d86867670d34d8c0e22f39ccd69b8eb61d863dfaacf1f0c667dd1c96f148dd869fe68ed4685b159d9706eaed6b1162d68f6bbab92d37981bff682ad826656b3fcbf7a9037cf904e3231863be4a63ac11422b6789d1463a44a05252ea194288550ab4641a61015c19091631006b9c109a39c389d4ea31e1919963df6921933d1789ea85798d3b5f89bb69ff8f29355efc2d18fa8cae31bd32da4e39fd2acfdb50523ff565a42f4c25ac14255dbcb98cd8a96ca878df06006821c1cb99fdef8d3033578d7097a37d4b9df2034b22deda94525a263e0c451ae0435300000000";
        let tx = deserialize_hex::<Transaction>(&raw_tx).unwrap();

        let prev_tx_raw_01 = "020000000001029d272d3644f4ace628eade757c075d4984b0ff73425fcacc3faca9e3443f7ae40000000000ffffffff335d226b78077c1cb772397cdf11ea8de1ce906242afab28c08b6b71da1d0d910100000000ffffffff01270600000000000016001492b8c3a56fac121ddcdffbc85b02fb9ef681038a024730440220323d0076caf5bda876eee325c5c60b3bb8281c0ddb401cf2418dbf7c79df509d02204d8293b1f4fb893ecd9ef82f5ab7129153418d3df40bdbd8742a784eaebf055f0121030c7196376bc1df61b6da6ee711868fd30e370dd273332bfb02a2287d11e2e9c5030101fdf50251690063036f7264010117746578742f68746d6c3b636861727365743d7574662d38004d08023c73637269707420646174612d733d2230783535666333626330373163613531633032396430366238386536333562633234646630383435396632636530646430646462386665646632623161613263623122207372633d222f636f6e74656e742f663830623933343636613238633565666337303366616230326265656262663465333265316263346630363361633237666564666437396164393832663263656930223e3c2f7363726970743e3c626f6479207374796c653d22646973706c61793a206e6f6e65223e3c2f626f64793e000000000000000062766d76341b5c0290ae066ca73351ec428a1a1de7be2ca4e9cdb2a37114a426cf4227fe7f85daccee1ed2c34dae1f150aa004473249090012d5026d8ed706c6e960373d142543c962fe9b9c1c10f8c5b6e70607944128394481f0662fb0c16030ec80c572a6b56c8779ffb9b60bb485ef9bc6226fa77b09733d639f09122e7d610367351374532b266123ebc3c5ff52a534bd6edc1cd449d32b7ed1e24ecea44a6704e1bddd1beb1c92b0c67b2527506b21b53411000d183452f140019d70d109cb49290a4a298c71434f6f7d90df8dee8398a61e37f82beaca9aeddcd5bad1bbfba83674c7bb7b817e2d90bddf0693f44cbbe0e1e75343c10163fb9cabe7db22c9f1b453e2ddaae5a7d9830707585324f8f68795ae9318093311e384721381cb09b400807e226ae5140181f68a4cc4494452dc5af45c0372728e81d41cb9b21b7a7aea15397dc2cc8fde3d0bdae7c31504c1acdd81da5bb7afdefda9518fa2928ee40ed6cbe5cb0fa76d74f5fcee3d76df007c1a68d0cae67c5cb733de901ee05b100fd60598bf9ab530d0e9858310394160c83d774e7b1096988996c5606102982565b9206951b910b5475241ba3644a334fffa880a90efe1a72a47f1655f96af1f507fbe5e5e973c3cebf447c943d9a213f5e0a79f0bfebf76d3d17506befa58fbd8425e7d22d41c2ff071c5c3071fd301006821c08864a1124013327b0fb7c49edd4b61f8b2de6fd5d37a840b99f73dc6fb23396400000000";
        let prev_tx_01 = deserialize_hex::<Transaction>(&prev_tx_raw_01).unwrap();

        let prev_tx_raw_02 = "02000000000101335d226b78077c1cb772397cdf11ea8de1ce906242afab28c08b6b71da1d0d910000000000fdffffff022c05000000000000225120f65e080b1450b51772a2345fd66a3e5e7913de5775294ac8969f33cf0c26b9715a5f01000000000022512075088bfac52b57aefff70f7ac9a6d2ae1e84b5bba7c4d9d7a130e57f8205a2b3014015424cf044180a6509213b8ea59aa915229b9bde83a268d4c3f7190a4641eb20e6b4fcf2dfa465a626ac818d8de50a5637db59ab8c7b56e91985f701c74fe6e100000000";
        let prev_tx_02 = deserialize_hex::<Transaction>(&prev_tx_raw_02).unwrap();

        let prev_txs = vec![prev_tx_01, prev_tx_02];
        let unsigned_input = check_witness_with_prev_txs(&tx, prev_txs);
        assert!(unsigned_input.is_some());
        assert_eq!(unsigned_input.unwrap().len(), 1);
    }
}
